# ==============================================================================
# CONTINUOUS INTEGRATION
# Ejecuta validaciones, tests y build. NO hace deploy.
# ==============================================================================
name: CI

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # VALIDAR CONVENCIONES
  # ============================================
  conventions:
    name: üìã Conventions
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          PATTERN="^(feature|fix|hotfix|release|docs|refactor|chore|test)/[a-z0-9][a-z0-9._-]*$"
          
          if [[ ! "$BRANCH" =~ $PATTERN ]]; then
            echo "::error::Branch '$BRANCH' no sigue la convenci√≥n"
            echo ""
            echo "Formato esperado: <tipo>/<descripcion>"
            echo "Tipos v√°lidos: feature, fix, hotfix, release, docs, refactor, chore, test"
            echo "Ejemplos: feature/login-oauth, fix/null-pointer, docs/api-guide"
            exit 1
          fi
          echo "‚úÖ Branch name v√°lido"

      - name: Validate commit messages
        run: |
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?!?: .{1,}"
          FAILED=0
          
          while IFS= read -r msg; do
            if [[ ! "$msg" =~ $PATTERN ]]; then
              echo "::error::Commit inv√°lido: $msg"
              FAILED=1
            fi
          done < <(git log --format="%s" origin/${{ github.base_ref }}..HEAD)
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "Los commits deben seguir Conventional Commits:"
            echo "  <tipo>(<scope>): <descripci√≥n>"
            echo ""
            echo "Tipos: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            exit 1
          fi
          echo "‚úÖ Commits v√°lidos"

  # ============================================
  # VERIFICAR DOCUMENTACI√ìN
  # ============================================
  docs:
    name: üìö Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required files
        run: |
          MISSING=()
          
          [ ! -f "docs/CONTRATO_TECNICO.md" ] && MISSING+=("docs/CONTRATO_TECNICO.md")
          [ ! -f "README.md" ] && MISSING+=("README.md")
          [ ! -f "Dockerfile" ] && MISSING+=("Dockerfile")
          
          if [ ${#MISSING[@]} -gt 0 ]; then
            echo "::error::Archivos requeridos faltantes:"
            printf '  - %s\n' "${MISSING[@]}"
            exit 1
          fi
          echo "‚úÖ Documentaci√≥n OK"

  # ============================================
  # LINT
  # ============================================
  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    needs: [docs]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci
      - run: npm run lint --if-present
      - run: npm run format:check --if-present

  # ============================================
  # TESTS
  # ============================================
  test:
    name: üß™ Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci
      - run: npm test --if-present

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true

  # ============================================
  # BUILD
  # ============================================
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - run: npm ci
      - run: npm run build --if-present

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build
          path: dist/
          retention-days: 1

  # ============================================
  # DOCKER
  # ============================================
  docker:
    name: üê≥ Docker
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # SECURITY
  # ============================================
  security:
    name: üîí Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          format: 'sarif'
          output: 'trivy.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

      - name: Upload results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy.sarif'

  # ============================================
  # CI SUCCESS (gate para CD)
  # ============================================
  ci:
    name: ‚úÖ CI
    runs-on: ubuntu-latest
    needs: [conventions, docs, lint, test, build, docker, security]
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "::error::CI failed"
            exit 1
          fi
          echo "‚úÖ CI passed"

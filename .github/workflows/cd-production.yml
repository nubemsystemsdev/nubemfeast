# ==============================================================================
# CONTINUOUS DEPLOYMENT - PRODUCTION
# Se ejecuta cuando CI pasa en main. Requiere aprobaciÃ³n del team.
# TambiÃ©n permite rollback manual.
# ==============================================================================
name: CD Production

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]
  
  # Permite ejecutar manualmente para rollbacks
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Tag de imagen (vacÃ­o = latest)'
        required: false
        type: string
      rollback:
        description: 'Â¿Es un rollback?'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: ðŸš€ Deploy Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    # Este environment requiere aprobaciÃ³n (configurado en GitHub)
    environment:
      name: production
      url: ${{ vars.PRODUCTION_URL }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Get current revision (for rollback)
        id: current
        run: |
          REVISION=$(gcloud run revisions list \
            --service=${{ github.event.repository.name }} \
            --region=${{ vars.GCP_REGION }} \
            --format='value(REVISION)' \
            --limit=1 2>/dev/null || echo "")
          echo "revision=$REVISION" >> $GITHUB_OUTPUT
          echo "Current revision: $REVISION"

      - name: Determine image tag
        id: image
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            TAG="${{ inputs.image_tag }}"
          else
            TAG="latest"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using image tag: $TAG"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: ${{ github.event.repository.name }}
          image: ghcr.io/${{ github.repository }}:${{ steps.image.outputs.tag }}
          region: ${{ vars.GCP_REGION }}
          flags: |
            --memory=1Gi
            --cpu=2
            --min-instances=1
            --max-instances=10
            --port=8080

      - name: Verify deployment
        id: verify
        run: |
          URL="${{ steps.deploy.outputs.url }}"
          TOKEN=$(gcloud auth print-identity-token 2>/dev/null || echo "")
          
          echo "Verificando $URL/health..."
          
          for i in {1..12}; do
            if [ -n "$TOKEN" ]; then
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $TOKEN" "$URL/health" || echo "000")
            else
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/health" || echo "000")
            fi
            
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Deployment verified"
              exit 0
            fi
            echo "Intento $i/12: HTTP $STATUS"
            sleep 10
          done
          
          echo "::error::Health check failed"
          exit 1

      - name: Rollback on failure
        if: failure() && steps.current.outputs.revision != ''
        run: |
          echo "::warning::Rolling back to ${{ steps.current.outputs.revision }}"
          gcloud run services update-traffic ${{ github.event.repository.name }} \
            --region=${{ vars.GCP_REGION }} \
            --to-revisions=${{ steps.current.outputs.revision }}=100

      - name: Create release tag
        if: success() && inputs.rollback != true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: prod-${{ github.run_number }}
          name: Production #${{ github.run_number }}
          body: |
            ## Production Deployment
            
            - **Commit**: ${{ github.sha }}
            - **Image**: `ghcr.io/${{ github.repository }}:${{ steps.image.outputs.tag }}`
            - **URL**: ${{ vars.PRODUCTION_URL }}
          generate_release_notes: true

      - name: Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "## âœ… Production Deployment Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | ghcr.io/${{ github.repository }}:${{ steps.image.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
